# はじめての Deno

目次

- 1 はじめに
  - 1-1 Deno ってなに
  - 1-2 Deno で出来ること
  - 1-3 Deno の特徴
- 2 Deno の開発環境を構築する
  - 2-1 Windows で Deno をインストールする
  - 2-2 Mac で Deno をインストールする
  - 2-3 Deno プログラムを実行するには
- 3 Deno プログラミングをはじめよう
  - 3-1 プログラミングとは
  - 3-2 Deno で計算してみよう
  - 3-3 データを便利に扱う - 変数
  - 3-4 どちらが大きい? - 比較演算子
  - 3-5 色々なデータ型
- 4 プログラミングの基本編
  - 4-1 条件分岐
  - 4-2 for 文
  - 4-3 関数
  - 4-4 エラー
- 5 非同期処理
  - 5-1 プロミス
- 6 プログラムからファイルを読み書きする
  - 6-1 ファイルから読み込む命令
  - 6-2 ファイルに書き込む命令
- 7 サーバーを作ってみよう
  - 7-1 listen
  - 7-2 dinatra

# 1 はじめに

本章ではプログラミングが初めての人向けに Deno の基本的な使い方を説明していきます.

## 1-1 Deno ってなに?

Deno は JavaScript の実行エンジンです. Deno では JavaScript 言語と Deno 独自の命令を組み合わせて様々なプログラムを書くことが出来ます. Deno は 2010年代にアメリカのソフトウェアエンジニアによって開発が始められました. Deno という名前は, Deno が参考にしている JavaScript エンジンである "Node" のアナグラム (アルファベットの順番並び替え) として名付けられました. Deno は英語の Dino (Dinosaur = 恐竜) と発音が似ているため, Deno のマスコットキャラクターは恐竜になっています.

<!--
Deno は新しい JavaScript の実行環境です. Deno では JavaScript 言語でプログラムを書くことが出来ますが, 通常の JavaScript だけではなく, ファイルにアクセスしたり, サーバーを起動したりするための命令などが追加されています. Deno ではブラウザの JavaScript では出来ないような様々なプログラムを記述することが出来ます.

(Deno によく似た JavaScript の実行環境で Node があります. Node は2009年から開発が始められて, 今でも活発に開発されている JavaScript エンジンです. Deno は Node の抱える問題点を解決するために 2018年から新たに開発が始められた新しい JavaScript エンジンです.)

Deno はオープンソースの JavaScript 実行環境です. Deno は JavaScript を実行することが出来ますが, ブラウザ上ではなく, サーバー上で実行することが出来ます. Deno はクロスプラットフォームな実行環境なので, Deno で書いたプログラムは OS (windows / mac / linux) にかかわらず動かすことが出来ます.

Deno にとてもよく似ているもので Node があります. Node は 2009 年にリリースされて現在も開発が続けられている JavaScript の実行環境です. Deno は Node の作者が Node の設計で失敗してしまったことをやり直すために 2018 年に改めて 1 から開発を始めた, 新しいソフトウェアです.
-->

## 1-2 Deno で出来ること

Deno は汎用の JavaScript のエンジンのため, コンピュータ上のあらゆる処理をプログラミングすることが出来ます. 例えばファイルを操作したり, インターネットからデータをダウンロードして収集したりするタスクは Deno は得意です. また, Deno はサーバーを立ち上げることも得意です. 標準ライブラリに含まれる http モジュールや, ws (WebSocket) モジュールを使えば, Web サービスのバックエンドになるサーバーを少ないコーディング量で作成することが出来ます.

<!--
Deno は JavaScript のエンジンです. Deno には通常のプログラミング言語のように, ファイルを読み書きしたり, ネットワークにアクセスするための様々な命令が用意されています. Web サーバーを作ったり, ネットワークにアクセスしてインターネットから情報を集めたりするのは Deno が得意とする仕事です.

JavaScript と聞くとブラウザを思い浮かべる人が多いかもしれません. Deno は JavaScript のエンジンですが, ブラウザとは直接関係がありません. Deno で動かしたプログラムを画面から操作したい場合には, 少し工夫が必要になります.
-->

<!--
通常のプログラミング言語と同じようにコンピュータ上で直接実行されます. Deno にはブラウザの JavaScript にはない様々な命令が追加

にファイルやネットワークなどコンピュータの持っているリソースに自由にアクセスする事が出来ます. Deno は Python, Ruby, PHP などのサーバーサイドのプログラミング言語に似ています.

Deno は汎用のプログラミング実行環境なので, プログラミングで出来ることは大体何でも出来ます. 特に以下のようなタスクは Deno でやるのに適しています:

- Web サーバーを作る
- Web サイトのスクレイピング
- コマンドラインツールを作る
- テキスト処理をする
- Websocket サーバーを作る
- etc
-->

## 1-3 Deno の特徴

JavaScript で簡単に書けるシンプルなプログラミング環境というのが Deno の特徴ですが, それ以外にもいくつか特徴的な点があります.

### TypeScript も使える

Deno は JavaScript だけでなく TypeScript も実行することが出来ます. TypeScript は基本的な文法構造は JavaScript とほぼ同じ言語ですが, 更に型情報を追加して記述することができます. 型情報を書くことで, プログラムの部品がどういう型を持っているかが自動的にチェックされるようになるため, プログラムのバグを減らす事が出来ます.

通常は TypeScript を利用する場合は, Node.js 環境から利用します. その際 tsconfig.json という設定ファイルが必要になり, ts-node や typescript などの各種 npm モジュールのインストールが必要になったり, 各種の準備が必要になります. Deno はそれらの設定を全て内部に含んでいるため, 準備の必要なく, いきなり TypeScript のソースコードを実行することが出来ます.

### 独自のセキュリティ機構がある

Deno は特殊なセキュリティのコントロールの仕組みを持っています. Deno は実行時にコマンドラインオプションで, プログラムが何をして良い, 何はしてはいけないということをあらかじめ決めてから実行します. 例えば, リンターのようなファイルの読み込みしか必要としないはずのプログラムはファイルの読み込み権限だけを与えて実行するのが適切です. リンターがネットワークアクセスを使用していたら何かがおかしい疑いがあります. Deno ではこのようなケースで

```
deno --allow-read linter.ts
```

のようにプログラムを実行することで, 実際にファイル読み込みしか許可しない状態でプログラムを実行できます.

更に Deno はホワイトリストの仕組みを持っています. 上のセキュリティコントロールを, ホワイトリストに対して細やかに行うことが可能です.

```
deno --allow-net=https://example.com test-request.ts
```

上の例では `test-request.ts` というプログラムを `https://example.com` というドメインへのネットワークリクエストのみを許可した状態で行わせることが出来ます.

このように, Deno では, そのプログラムが本来使用するべきコンピュータの機能に絞って権限を渡す仕組みがあります. これは意図しない第3者の攻撃コードがソースコードに混入してしまった場合に, 被害を防げるという利点があります.

近年 Node では, パッケージレジストリの npm に攻撃コードの混入が見つかるケースが増えています. 攻撃者は典型的には攻撃コードを使って, そのコンピュータの機密情報を盗もうとしますが, その際攻撃者は自分が用意した受信用サーバーに機密情報を送信する必要があります. Deno のセキュリティの仕組みを使えばこの送信時のネットワークアクセスを防ぐことが出来るため, このようなタイプの攻撃が成り立たなくなります.

<!--
Node のパッケージレジストリの npm では最近では攻撃コードの混入が見つかるケースが相次いで発覚しています. npm には, 大小様々な規模のライブラリが登録されていて, ライブラリがさらに別のライブラリに依存するのが当たり前になっています. 結果的に一つの業務アプリを作る場合に依存するモジュール数が10万を超えるようなことは当たり前になってきています. そういう中で全ての依存モジュールをいちいち監査しながら開発をすることは不可能であり, そこに目をつけた攻撃者が多くのパッケージから依存されてるパッケージを乗っ取り攻撃コードを混入させる行為が後を絶ちません.

Deno の特徴の一つで独特なセキュリティのコントロールがあります. Deno は実行時にコマンドラインオプションで, プログラムが何をして良い, 何はしてはいけないということをあらかじめ決めてから実行します. そのため, そのプログラムのどこかに, 意図せず攻撃者の仕組んだ攻撃コードが入っていたとしても, セキュリティのコントロールをしていれば被害を防ぐことが出来ます. Node の世界では毎年何回か npm モジュールが攻撃者に乗っ取られて, 攻撃コードがモジュールに混入される被害が年に数回は起きていますが, Deno ではそのような攻撃を Deno のセキュリティ機能を使って防ぐことが出来ます.
-->

# 2 Deno の開発環境を構築しよう

それでは実際に Deno を動かすための環境を構築していきましょう.

## 2-1 Windows で Deno をインストールする

この節では Windows に Deno をインストールする方法を説明します.

{SS: デスクトップ:左下検索に矢印}

左下の検索ボックスに `powershell` (TODO: チェック) と入力してパワーシェルを開きます.

{SS: パワーシェル}

パワーシェルが開いたら, 次のように入力して Deno をダウンロードしましょう.
TODO: チェック
```
iwr deno.land/x/install/install.ps1 -useb | iex
```

以下のように表示されればダウンロード成功です.

{SS: DL 完了の図}

ダウンロードが成功したら, 環境変数の設定をしていきましょう.

左下の検索ボックスに, コントロールパネルと入力して, コントロールパネルを開きます.

{SS: デスクトップ:左下検索にコントロールパネル}

コントロールパネルからシステムと環境設定を右クリックします.

{SS: コントロールパネル内システムと環境設定右クリックした図}

環境変数の設定を選択します.

{SS: コントロールパネル内システムと環境設定}

`Path` 環境変数を選びます.

{SS: 環境変数設定画面}

`c:\.../deno` を入力して, 保存を押します. (TODO: インストールパスチェック)

パワーシェルに戻って, `deno -v` と入力します.

{SS: deno -v in psh}

上のように Deno のバージョン情報が表示されればインストール完了です.

---

コラム: scoop を利用する

scoop がインストールされている場合は, 次のコマンドで deno をインストールすることが出来ます.

```
scoop install deno
```

この場合は環境変数の設定は不要です.

---

## 2-2 Mac で Deno をインストールする

{図: マック, デスクトップ}

画面右上の🔍をクリックしてスポットライトを開いてください.

スポットライトの検索ボックスに「ターミナル」と入力して, ターミナルアプリを選択してください.

{図: ターミナル}

上のようなターミナル画面が開いたはずです.

ターミナル上で, 下のコマンドを入力して Deno をダウンロードしましょう.

```
curl -L deno.land/x/install/install.sh | sh
```

ダウンロード完了したら, 以下の行を `~/.bash_profile` に追加して `deno` コマンドにパスを通します.

```
export PATH=$HOME/.deno/bin:$PATH
```

以上を `~/.bash_profile` に追加したら, 下のコマンドを打って, `~/.bash_profile` を再ロードします.

```
. ~/.bash_profile
```

ここまでで Deno のインストールは完了です. インストールできたことを確認するために, 下のコマンドを打ってみてください:

```
deno -v
```

インストールが成功していたら, 以下のように `deno` バージョン情報が表示されるはずです.

```
$ deno -v
deno: 0.13.0
v8: 7.7.200
typescript: 3.5.1
```

上のメッセージが確認できたら, インストールは完了です.

---

コラム: Homebrew をインストールしている場合は brew コマンドでもインストールできます.

ターミナルから以下のコマンドを叩いてみてください.

```
brew install deno
```

こちらのコマンドでインストールする場合は `~/.bash_profile` の編集は不要です

---

## 2-3 Deno プログラムを実行するには

Deno のプログラムの実行の仕方は大きく分けて2種類あります.

1つはインタラクティブシェル(対話型入力欄)からプログラムを直接入力するやり方です. もう1つはファイルに保存した Deno プログラムを `deno` コマンドに読み込ませて実行するやり方です.

### インタラクティブシェルから Deno プログラムを実行する

先ずはインタラクティブシェルから Deno プログラムを実行する方法を説明します. インタラクティブシェルというのは Deno の対話型の実行環境のことです. この環境に入ると, 入力した Deno プログラムを即座に Deno が実行し, 結果を返してくれます. このような環境のことは REPL (リプル, Read-Eval-Print Loop) とも呼ばれます.

インストールの節で説明した方法で, 先ずはターミナル(パワーシェル)を起動してください.

ターミナルで, 次のように `deno` と入力して [Enter] キーを入力してください.

```
deno
```

すると次のように `>` の記号が表示されるはずです.

```
deno⏎
>
```

このような表示にならなかった場合は, インストールがうまくできていません. 前の節に戻って, インストールの手順をもう一度確認してみましょう.

`>` の記号が表示されたら, この状態がインタラクティブシェル環境です. ここに Deno プログラムを入力することが出来ます.

まずは以下のように入力してみましょう.

```
> console.log("hello world")
```

最後まで入力したら [Enter] キーを押します.

すると次のように 1行下に `hello world` の文字が出力されるはずです.

```
> console.log("hello world")⏎
hello world
```

上の出力が確認できれば, インタラクティブシェルからの Deno プログラムの実行が成功したことになります.

### Deno プログラムを書いたファイルを実行する

次にファイルから Deno プログラムを実行してみましょう.

上で入力したのと同じ内容の文字列を, ファイルに書いて保存しましょう.

```
console.log("hello world")
```

保存したら, 再度ターミナルを開き `deno` と入力し, 更にスペースを1つ入力し, その状態で保存したファイルをターミナルにドラッグ・アンド・ドロップしてください.

すると, ターミナルにファイルのパスが表示されます.

```
deno /Users/kt3k/Desktop/hello.js
```

この状態でエンターキーを押してファイルを実行します.

```
deno /Users/kt3k/Desktop/hello.js⏎
hello world
```

上記のように `hello world` と表示されれば成功です.

# 3 Deno プログラミングをはじめよう

ここまでで Deno でプログラムを動かすことが出来るようになりました. この節からは, Deno を使って基礎的なプログラミングを学んでいきましょう.

## 3-1 プログラミングとは

そもそもプログラミングとはなんでしょうか? 私たちは普段人にものをお願いするときは, 日本語でしてほしい事をお願いします.

一方, コンピュータに何かをしてほしい時に, 日本語で頼んでもコンピュータには理解できません. コンピュータに理解できる言語を使う必要があります. そのようなコンピュータに理解できる言語が「プログラミング言語」と呼ばれるものです.

ここで人が話す言語とプログラミング言語の関係を表にすると以下のような対応関係になります.

|対 人間   |対 コンピュータ   |
|----------|------------------|
|言語      |プログラミング言語|
|文書を書く|プログラミング    |
|文章      |プログラム        |

人が話す言語には日本語, 英語, 中国語など様々な種類があるように, プログラミング言語にも JavaScript, Python, Go のように様々な種類があります.

## 3-2 Deno で計算してみよう

それではターミナルを開いて `deno` [Enter] キーと入力してインタラクティブシェル環境を開いてください. ( やり方を忘れてしまった人は → 2-3 節を参照してください. )

```
deno⏎
>
```

上のような記号 > が表示されたはずです. この状態は Deno のインタラクティブシェルというものでした.

### 足し算, 引き算

足し算は `+`, 引き算は `-` で計算することが出来ます.

ではまず 1+1 を Deno で計算してみましょう. 1+1 と入力してから [Enter] キーを押してみましょう.

```
> 1+1⏎
2
```

では, 他の計算もしてみましょう.

```
> 3+5
8
> 12+56
68
> 5-2
3
> 56-30
26
> 1729-3000
-1271
```

### 掛け算, 割り算

掛け算は `*`, 割り算は `/` を使います.

```
> 34 * 12
408
> 100 * 1.08
108
> 56 / 7
8
> 56 / 9
6.222222222222222
```

### 演算子の優先順位

足し算, 引き算, 掛け算, 割り算の使い方がわかりました. これら4つの演算をまとめて4則演算と呼びます.

次に, これらの4則演算を混ぜて計算してみましょう.

```
> 10 + 20 * 3 - 40
30
> (10 + 20) * 3 - 40
50
```

このように, 足し算と掛け算が混ざっている式の場合は, 掛け算が優先して計算されていることがわかります. このルールは数学の四則演算の優先順位のルールと同じです.

### 剰余 (割り算のあまり)

4則演算以外にも計算をするための演算子が用意されています. `%` 記号を使うと剰余演算(割り算の余りを求める計算)を行うことが出来ます.

```
> 4%3
1
```


## 3-2 データを便利に扱う - 変数

## 3-3 どちらが大きい? - 比較演算子

## 3-4 色々なデータ型

# 4 プログラミングの基本編

## 4-1 条件分岐

## 4-2 for 文

## 4-3 関数

## 4-4 エラー

# 5 非同期処理

## 5-1 プロミス

# 6 プログラムからファイルを読み書きする

## 6-1 ファイルから読み込む命令

## 6-2 ファイルに書き込む命令

# 7 サーバーを作ってみよう

## 7-1 Deno.serve

## 7-2 dinatra

# 参考文献
- 考える力が身につく Python 「超」入門 鎌田正浩
- JavaScript Primer @azu

